-*- text -*-
TODO list for M
$Id$

*********************************************************************
*** Suspicious, to be tested:
*********************************************************************

 - on Alpha: no XFace inserted, trying to convert ~/.xface to ~/.xface.xpm although already an Xpm
 - mAppBase::OnExit() gets called twice

*********************************************************************
*** not fixed yet:
*********************************************************************

wxGTK bug:

 - listctrl can have no focused element, i.e. the assert in
   wxFolderView.cpp:85 can be triggered

 - treectrl ignores icon sizes

VZ:
- wxConfig does not like entries like:
  Key=Value
  but insists on
  Key = Value

- upgrade.cpp causes three problems that I hope you can understand:
  - p2->DeleteGroup("Folders") triggers an assert deep inside the
    wxFileConfig/wxDynArray code. The group "Folders" exists, the path
    is set to M/Profiles before deleting it, so it's apparently a
    wxFileConfig bug. (line 165 in upgrade.cpp)

  - the code with GetFirstGroup()/GetNextGroup() does not find all
    groups under "Folders". The Profile functions change the path
    before calling wxConfig::GetXXXGroup() but, obviously, always to the
    same path, not causing any change.
    This seems to be a bug in wxFileConfig, or at least, some
    undocumented behaviour.
    I worked around it in CopyEntries(), building a list of all groups
    first and then traversing them afterwards. Not important for M anymore.

- Initially selected folder is not highlighted in treectrl.

- How can I make wxLogXXX message have appear in the order they were
  generated?
  + VZ: derive your own log target :-) But I think the default order
        is more sensible

- wxComboBox textctrl allows editing!
- MTempFileName is broken: all files remain in /tmp!!!
- .mailcap should override /etc/mailcap, not other way round
- help button and more fields for folder creation dialog

- MailFolder now reads the "RetrievalLimit" config value and will not
  retrieve more messages than that from server. Need support for it and
  for anonymouse flag in folder creation/properties dialogs.

- the listctrl seems to have a problem with nntp folder names like
  {xxxx/yyy}newsgroup
  After accessing them, the next program start produces an error
  because there is more than one entry for their column sizes in the
  config file.
  I am now using static ProfileBase::FilterProfileName() to avoid that.
  Not ideal, though.

- If any top level window is open (messageview/composeview), the
  application will not exit. Happened after you changed the exit
  behaviour, has been a bug for months.
    VZ: can't reproduce this

- closing splashscreen calls wxApp::ExitMainLoop() which is wrong!
    VZ: can't reproduce this

******* Priorities for KB: ******************************

DONE:
- Modify MailFolder interface to take UIDs instead of listing indices
  everywhere. This is important for "Views" to be implemented.
  --> add test for validy of uid
- ISO8859 encoded message headers!

- the selection in wxFoldreview should store uids directly, currently
  the wxMessageview of a standalone viewer passes its msgno to some
  functions but msgnos might have changed in the meantime.
- Things like CopyMessagesToFolder need a return code indicating
  whether they were successful or not, otherwise MoveMessagesToFolder
  deletes them in any case. Trivial to add.
 --> Clicking ABORT doesn't return false!
- MessageCC::Addresses() returns empty name for Morten Poulson  WHY?
- add news posting
- forward messsages as 7Bit, i.e. provide 7bit/8bit selection in
  SendMessageCC::AddPart()
  done-->  // check whether enc8bit is needed or not
- support for local news spool
- gtk 1.2 support seems to work
- add -ljpeg to linker options and JPG as intermediary image format
- have a global "NewMail" folder setting and ensure its existence
- MessageCC::GetBody() can return with body/envelope == NULL if
  message no longer exists. Just got a crash in Refresh().
  Add a CHECK() wherever it is called.
- do wxImage changes affect list of available handlers, etc?


CHECK:
- printer settings seem to have no effect : are persistent, do they get used?
- MailFolderCC:
   -if mailfolder has been closed due to timeout, reopen it.
 - SendMessageCC: allow re-sending of aborted send, i.e. Send() called
                  more than once
- make mailfolders collectable:
  - have a "collect" flag
---> done, after merging of profile code, add support for building
     list of these folders and periodically checking them.
     TEST!!!!
- suppress mm_log() checkpoint completed messages

TODO:

- MFolder.i

for release:

- remove dialog box in MailFolderCC::Ping about reopening folder!!!
- update the list of folders to poll for new mail when the folder
  properties are changed, tricky.

- When mm_log reports a "Unexpected change", do a Ping(), trying to
  reopen the stream.
- config panels are too small/too full, move font settings somewhere
  else, i.e. have a "layout" page?

- do we really need to scan /var/lib/news/active?
- more configurability for news

doc: add note about news active file

- add URL highlight colour

after release:

- more configurability for news
- add auto collection to compose view
- add a popup dialog to edit message headers in composeview
- some html mail import/filtering of tags (easy, quick and dirty)
- copying message to non-existing folder gives error message but works
- Change MessageCC code to first look for a mail cache entry via
  mail_elt() instead of always fetching message. (REALLY REQUIRED?)
  Is already like this, but fetch_overview() does an extra fetch, even
  in mtest.
STRANGE....

= wxLayout:
  - merge my colour changes into wxGTK/devel version
  - fix horiz scrollbar size
  - update rectangle (needs support in wxllist and wxWindows)
  - fix(simplify) cursor size calculation
  - font optimisations(!)
  - copy/cut/selections
  - occasionally wraps lines wongly (twice) ??
  - UNDO
  later:
    - DragNDrop (waiting for wxGTK/gtk1.2 & GNOME 1.0 / Debian Slink)
    - cut&paste (paste is there but broken in wxGTK)
  done:
    x- reset scrollbars on Clear()
    x- add setting of background colour and/or image
    x- composeview: after inserting text (reply), update scrollbars
    x- fix initial scrollbar sizes --> seems ok, what exactly is wrong?
    L- delete in empty line doesn't work

- add progress indicator to image loading
    (and the one of SentFolder) in VerifySettings()
- do not redraw messageview if the message is the one currently being
  shown (DONE, better:)
  -- option to keep wxLayoutList around for reuse?

- show status dialog while importing graphics into messageview
- when inserting filetype of unknown MIME type, prompt for it

- implement Compose/Reply templates

- merge font settings in wxComposeView/wxMessageView to share code

- speed up copy mail to folder by cusing c-client functionality
  wxComposeView: if replying, only mark message as answered if reply
  got sent --> difficult


- add a message/delivery-status icon (like message, but with a red 'S' ?)

- IMAP progress updates don't appear because there is too much to be
  done in wxYield()?

- occasionally parts of xface header show up in following mail header
  lines (content type/parameters)


- possibly have a MIME types editor (similar to netscape's?)
- if time permits: vcard-import

- support for local news spool

- Let Iconmanager chose handler by format! JPEG crashes program if fed
  the wrong filetype! Handler can return extension, caller should do
  the same.
- make message view use the new font settings.
**************** end of KB priorities :-) *********************


- add some more folder properties to config dialog, i.e. be able to
  switch off automatic notification of incoming emails.
- cannot select only message in a folder or first message without
  chosing a different one first

- make message view use the new font settings.
- improve header support
- add support for faxing mails via tpc.int
- folderview listctrl has extra Subject column behind Size field ???
- when inserting filetype of unknown MIME type, prompt for it,
  possibly have a MIME types editor (similar to netscape's?)
- forward messsages as 7Bit, i.e. provide 7bit/8bit selection in
  SendMessageCC::AddPart()
- add "double click to open" profile option support to folder list ctrl
- allow angle brackets and full name <> in reply-to field.
- folder set message flag update hook takes too long for really large folders
   ==> code commented out in MailFolderCC.cpp

 - merge many Re: into one, optionally Re[n]:
 - easy to implement but useful features:
 - "check for new mail now"

- use mm_critical() and delay application exit if necessary
- delete temporary files (esp. from image conversion!)
  - easy: add support for email-to-fax gateway at www.tpc.int and
    their coverpage

 - Memory leaks whenever using wxMessageView (there are some from
  cclient) still there?

 - handle "truncated mailfolder" more gracefully (i.e. close and re-open folder)
   VZ: when 2 mail clients are running simultaneously and the message is deleted
       from the spool M crashes with meaningless backtrace.
       Didn't happen to me but c-client produced an error message and deactivated
       the mail stream.

 - document scripts in extra/scripts

 - somehow allow different configs for different hosts, maybe a
   [M/HOSTNAME/Profiles] section overriding [M/Profiles]?

 - Add a way to query news and imap server for a list of
   folders/groups, subscribed folders/groups and to subscribe to them
     --> mainly a GUI issue

 - toggle readonly status of mailboxes?

 - OptionsPanels:
   -add a help button which calls a help id depending on which page we're on
   - confirm exit button does have no effect and should be Yes No Ask
     Radiobox anyway

 - GUI problems:
  - configuration panels way too large!
  - log window occasionally doesn't layout menu correctly (here too, no
    idea) wxGTK bug

  - replace the ugly "Insert File" icon with one looking more like the
    other icons
  - folder tree control should (configurable on a per-folder basis)
    highlight and count the number of new messages
  - add "Inline" option for MIME popup on graphics
  - The "Specify global M directory" dialog doesn't save its value.
  - typing keys while M starts up can cause segfault (startup-splash
    event handling?)


- ADB:
  - ADB lookups take to long, delay in switching between messages, add a
    "message/collect address" menu and keyboard binding
  + make AdbEdit auto-generate a formatted name from first/family-name
    and prefix/title.
  + for names without entries, use the same method for name generation
    as ProvBBDB for consistency
  + add "add current address to ADB" to compose view
  + should be updated when new entries are created (can't be deleted from
    elsewhere for now...), add an event for this
  - can't open autocollect.adb in AdbEditor if already opened (can't reproduce
    any more)
  - ADB: does not use substring??? (Joen_Doe no expansion for
    "doe" or "Doe")
  - closing adb editor while entries are selected somewhere (at least
    in bbdb) causes error messages when opened the next time because
    it cannot select the entry again
  - copying between address books and groups
  - BBDB: sort entries by surname
  - add ADB support for $HOME/.mailrc
    ( lines: "alias john_doe  john@doe.com, second@xxx.uuu, ...")


(Windows)
 - memory leaks (run Purify on it)
 - options dlg layout looks ugly (radiobox is way too big)
 - in folder create/properties dialog there is missing UpdateUI() right
   after creation - add it somewhere
 - lock file checking for INBOX:
   + it does locking under Windows too, but the lock file names are different
     Testing for FOLDER.lock* now, is that fine?


*********************************************************************
*** things to fix/implement next ***
*********************************************************************
- drag and drop of messages between folders
- configuration dialog for columns in folderview
- alternative treecontrol instead of listctrl for folderview
- anonymous IMAP access (VZ: I'll do it)

- use wxURL to retrieve remote configuration files and import them,
  maybe even retrieve files to use as folders or address books`?

- wxFolderCreateNotebook should be split into base class and 2 derivations:
  wxFolderCreateNotebook and wxFolderPropNotebook

- put number of total/unread/new msgs in the status bar for the selected
  folder in wxMainFrame, also draw the folders with the new mail in bold
- Are wxConfig/Profile GetNextGroup()/GetFirstGroup()  thread-safe??
  I started marking possible problems for multi-threaded code with
  //FIXME:MT
  VZ: ok, I usually do it too (always) except for the "obvious" problems, e.g.
      usage of static vars. I always name them with "s_" prefix (for this
      reason too) so it should be quite easy to do a grep for them later
  - MT-problem: rfc822_extraheaders()
  - MT-problem: wxlparser export function uses static variable

- add "Send Digest"

- detect one's own messages (i.e. mark "Myself" in "From:" or, as XFMail
  does, mark "To: ..." in "From:" column for them) and optionally suppress them
  completely.

- configurable ReplyString


- integrate new IMAP c-client library CAREFUL: rfc822.c has changed, old patch no longer
  valid:
   This is the new code for rfc822_extraheader_lines:

	void rfc822_extraheader_lines (char **header,ENVELOPE *env)
	{
	   char **names = rfc822_extraheader_names;
	   char **values = rfc822_extraheader_values;
	   while(names && *names)
	   {
	      if (values) sprintf ((*header += strlen (*header)),"%s%s: %s\015\012",
				 env->remail ? "ReSent-" : "",
				 *(names++),
				 *(values++)
				 );
	   }
	}


- KEYBOARD BINDINGS AND TAB TRAVERSAL (!!IMPORTANT!!)

- add !(command) expansion to wxConfig, i.e.
  VAR=!(hostname):me would execute "hostname" and return "hydra.medieval.de:me"

- reply/forward buttons for messageview/folderview
- only quote the selected text in reply/forward if there is any selection
  (as in XFMail) - very handy
- update FolderView if mailbox has shrunk  (which callback gets called?)

- look into wxListCtrl reset after dialog box popup

- rearrange some preferences pages, distinguish between compose options
  and compose window layout (BCC label etc)

- Add the real folder create panel to the folder create notebook

- DND with gmc (dead easy, see dnd example :-) )


- announce M on bbdb mailing list

  + add Picture field to Adb
    VZ: what should it contain? a file name? ...let's do this later
  + implement "internal clipboard" for
    - cut-&-paste
    - drag-&-drop

  + some fields are sometimes created disabled under Windows - very mysterious...

- UI things
  + we should somehow merge the toolbars into the main frame toolbar if it
    shows the folder view, for example
  + session management

- Python
  + fix Python problems -- what's wrong? No idea why Setup.py doesn't work.
  + add remaining (important) interface definitions
  + user/global Minit files, security issues
  + add OnNewMail callback by counting messages in mailbox
    + add sample callback showing new messages
  + merge in wxPython

- find a way to run stripwxhelpids from Manual automatically
- merge text parts into one, send non-MIME mail


*** to implement in near future ***

- fix non-ASCII characters in header lines (important!)

- event subsystem
  + write some macros for safe casting of the event param in the handlers to
    the correct type
  + separate "folder tree change" event in "pre" and "post" kind
  + may be introduce return values?

- news reader functions
  + get the list of newsgroup and allow to choose from them
  + propose to get only some articles when there are more than some number of
    them (opening a never-read newsgroup takes _ages_)
  + "catch up" command
  + filtering of cross posted articles - would be very nice if this could be
    also used to filter the copies of received mail messages (i.e. if a
    message is sent to the mailing list and cc'd to me I'd like to read it
    only once)

- wxFolderView assumes that msg numbers are 1...n - change this to use uids instead.

- Use configure to check for utilities, like help browser. "ReConfigure" menu.

- Edit-CC, CC messages to others but edit the individual copies before sending

- SendMessageCC should derive from a SendMessage abc

- threading of messages via MessageId/References header lines
  Follow examples in SunExpert journal.

- "Power Search": search all (even compressed?) folders for a keyword
  and when found, open the folder and display the message.

- Export and import of addressbook in text format.
  I'd like a feature to select fields from the addressbook and write
  them, e.g. semicolon separated as a list to a file, so one could
  parse them in scripts or whatever else.

- message integrity verification support
  + PGP
  + MD5 (see RFC-1544 for details)

- REMOTE-CONTROL: add support for popping window open and reading a folder of one's choice
  (for being controlled from xbiff like programs)
  idea: listen() on a socket and write socket number to a file ~/.M/socket

********************* long-term projects ***********************

- Support for different charsets (Unicode/utf-7/8?)

- LDAP -- possibly using python ldap module or OpenLDAP.

- automatic (but optional) mail compactification (to save disk space)?
  -> this could be done using scripts?

- creation of separate index files for mail folders

- compressed mail folders

********************* targets for re-write **********************

MailFolder::OpenFolder() are so confusing (login for NNTP is the newsgroup!!)
that even you apparently forget what is what - let's call the newsgroup
parameter "newsgroup" even if we will have unused parameters for each call...

Clean up MailFolder/Message classes as part of header/class rewrite
for modularisation. Share common code in
MessageCC/MailFolderCC/SendMessageCC and somehow integrate SendMessage
classes in the hierarchy.

- !!! non-blocking message retrieval !!!

********************* known wxWindows bugs **********************

- font mess (wxGTK)
- constraints
  - Ian Galbraith complained about being unable to enter anything into
    the compose view (all wxTextCtrls in wxFrames instead of dialogs under
    OpenLook WM)  --> wxGTK bug, ignore it!

- wxMemoryDC and Blit() cannot handle non-(0,0) viewports

*********************************************************************
*** Fixed, to be tested:
*********************************************************************
 - wxLayout:
   + clicking before begin of line (wrongly) gives assert


*********************************************************************
*** Fixed and tested:
*********************************************************************
- when creating a newsgroup folder, subscribe to it, so it appears in .newsrc
- ReplyTo flag should work now
- Fix occacions "Sequence invalid" (when marking/replying message)
-  new mail dialog getting stuck?
- sometimes M is very slow sending a message, why? (was server)
- fix status flag indicators (N/U seem to be wrong)
  -> new messages are marked as N, when viewed, they change to U
- is leading * for NNTP folders a good idea? NO - why does PINE do it?
- add TO: field to folderview
- send new mail events again - why have they disappeared?
- new mail dialog shows empty folder name when more than one message
  has arrived
- Solaris: all helpers need absolute path or won't get found
- Proper NNTP support and POP3 fetch solution are the same thing:
  - Use mail_fetch_overview() and implement it on the MailFolder
    interface. Use that new function in wxFolderView::Update() to
    display header lines. For NNTP this will only list the messages
    which exist on the server and are unread (not deleted).
    Use this somehow to update the count of messages in the folder.
 - suspected bug in MEvent code causing lockups/endless memory allocation
 - sometimes mailfolders/messages seem empty
 - A problem with expunging message from MailFolderCC: as the messages
   are queued, they cause fetches of messages which no longer exist
   because the count has not yet been updated.
 - make Message use refcount
 - add message/move to folder
 - copying to other folder only writes headers, no content
 - allow '=' in urls and don't allow ' '
 - help fails to find copyright
 - .mo files should be found in M_BASEDIR/locale
 - toolbars need to be a bit higher
 - crash when switching off header display in messageview
 - forwarding message triggers assert in wxComposeView:119
 - password entry field needs to use password setting to hide text
 - add explaining texts to python dialog
 - Toolbar sizes are wrong. --> used ugly workaround in
                                wxMainFrame.cpp which works most of the time
                                Robert is aware of this.
 - set permissions for config files (passwords!) (This is done in Profile.cpp now
   but should really be in wxConfig code)
 - SentMessages folder sometimes looked up in wrong directory (seems ok)
 - SentMail folder looked up in wrong directory still and gets
   overwritten instead of appended to
 - funny: X-Face/X-Mailer headers get sent but don't appear in SentMail folder.
 - BBDB file format in read-only mode seems to work, needs a bit more
   testing, crashes are gone
 - BBDB save on exit, and parsing it in again
 - BBDB miniframe needs parent and text needs to move down
 - add explaining texts configuration panel  (return address, hostname)
 - add Statusbar to wxMessageView
 - deleting message ("Messsage|Delete") doesn't work
 - configuration panel got stuck on Solaris (usual constraints problem,
   goes away after resizing) -- (VZ) it happens to me under Linux too sometimes
   (occasional wxGTK bug?)
 - new "new mail" message seems to show wrong number
 - user name no longer contains additional fields
 - wxAboutDialog:
   + has extra wxYield() to improve display at startup
   + scrollbars should disappear now
 - deleting messages from wxMessageView doesn't work
 - wxLayout:
   + "Home" key is funny  (fixed)
   + some other keys are funny, too, ignore control characters
   + flicker is gone, scrollbars are fine
   + some more keyboard bindings (ctrl-u/k)
   + make it have a border (easy via offset!)
   + scrollbar settings  .. work perfectly fine for me
   + Delete() in wxLayoutList is broken (ctrl-y triggers it)
   + cursor corrupts last character
 - MFrame icon not found, compile it in. (lowercase?!)
 - strange lyx/latex problems (caused by % in rawhtml section)
 - toggle headers doesn't work
 - wxLayout
  + printing takes ages to find .afm files
  + does word wrap work?
  + cursor bitmap occasionally causes segfault in bitmap generation
    (odd dimensions?) (no longer used)
  + horizontal scrollbar doesn't jump to cursorpos when newline
  + "Home" key is funny  (fixed)
  + cursor movement must be displayed properly ( redraw function marked
    with //FIXME)
  + already faster, but could get even faster. Layout/Draw only parts of the list
 - wxllist::Delete() is almost surely broken, but behaves fine
 - treecontrol uses folder names starting with "/" which must not be passed
   to wxFolderView, etc. Folder names do not start with a slash, but are relative.
   Especially, "INBOX" != "/INBOX".
   I added a crude hack to wxMainFrame::OpenFolder() //FIXME
   and wxFolderTree.
 - documentation system should support pictures
 - wxComposeView::Print() fails, wxMessageView::Print() works, why?
  - add (simple) keyboard interface to folder view (?)
    (at least d,n,p or something like that)
 - forwarding messages broken, no content
 -   Currently, coying emails to another folder produces "New Mail" dialogs.
 - creating new folder and immediately after doing a message/copy to
   folder caused crash
 - when calling netscape to view URL, M locked up (after writing
   "done"), top showed two M processes and after a while it terminated
   with an IO trap
 - wxlwindow: MIME menu appears at wrong position again
 - make Message class use reference counting !
 - new mail dialog:
   + sometimes From: is empty
   + if more than one new mail, info for one of them is duplicated
   + apparently if mails have been deleted in the meantime, counter
     must be updated
 - wxLayout:
   + printing needs better scaling how does sample do it?
   + use smaller fonts for printing.
   \--> works well like now, but setting the printer scale smaller
        reduces page size, just rescale fonts instead
 - integrate new c-client lib 4.5
 - Profile readEntry() needs interface extension to allow a boolean success
   value, remove hacks like 17 or "illegal value"!
 - POP3: loading all message contents(why?) and twice(why?)
 wxFolderView:
 - clear MessageView, for this:
 - modify wxMessageView to only temporarily use Profile when needed, so
   it doesn't stay with the old folderview profile
 - investigate problem of empty message bodies (e.g. on Micky's mails
   from the Scottish Office).  SEEMS GONE!?
 - suspected bug in LoadImageXpm in wxIconmanager leading to crashes
 - wxListCtrl in folderview behaves properly now
 - could we have each flag at its own position in folder view listview? I.e.
   now they all appear in sequence and I'd like each of them have its own
   position (looks better and it becomes easier to spot, for example, all
   unread messages)
    KB: done that.
 - entry names containing "+" will get created and garbled/lost on
   re-load as they are illegal characters in wxConfig entry names
 + config entry names should allow  ',' (needed for mail names which
   might contain it, just received one from "john doe, archeology"),
   the same for apostrophes
DONE:

Add choice of intermediary image format:
  PNG, JPG, XPM
  --> prefer JPG, Imagemagick PNG support is faulty!
- If mail is from efax.com and contains an application/octet-stream,
  use tiff2ps and ghostview to generate an application/postscript
  instead. (Just convert the type to image/tiff-g3 and implement our
  own handler for that.)
  EFAX now sends image/tiff!
  Configurable! Options for tiff2ps!
  >>> Finish this: have share/M/mime.types with tiff2ps/gv combo
- .newsrc read/write  --> should be there?!
  For nntp folders, mark read messages as deleted. Somehow provide
  feedback! At close, ask whether to mark all messages as read.
  --> .newsrc does get updated! :-)

- check in new options panels
  - add help button in notebook, linked to help ids in panels

- when doing "select all", disable OnSelect() for folder listctrl


- Is this needed?
  And disable events!
  When doing a Delete() etc, do not rebuild the
  listing between, this corrupts message numbers!
  Find a clever way to handle this, build a sequence first!

- retrieve messages starting from last one
- fix bitmap allocation in SetBackgroundBitmap() calls (seems ok now)
 - save and restore printer settings in profile

- fix occasional segfault/memory corruption in MailfolderCC.cpp
   + this might have been caused by the bug with rfc822_extraheaders
     and be fixed now -- wait and see (seems gone, 22.3.99)
- add msgview.xpm icon to repository (forgot it at home)
- save and restore printer settings in profile

- folderview listctrl has extra Subject column behind Size field ???
  Looks like a wxGTK bug that seems to have disappeared in the meantime.
  However, using ClearAll() instead of DeleteXXX() now to simplify
  things a bit.


 vi: set si tw=80:
