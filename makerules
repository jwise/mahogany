# -*-makefile-*-
# rules to create object files:
#
ifdef USE_LIBTOOL
%.o: %.cc
	$(LIBTOOL) --mode=compile $(CXX) -fPIC $(CXXFLAGS) -c $<
%.o: %.cpp
	$(LIBTOOL) --mode=compile $(CXX)  -fPIC $(CXXFLAGS) -c $<
%.o: %.c
	$(LIBTOOL) --mode=compile $(CC)  -fPIC $(CFLAGS) -c $<
%.lo: %.cpp
	$(LIBTOOL) --mode=compile $(CXX)  -fPIC $(CXXFLAGS) -c $< 
%.so: %.lo
	$(LIBTOOL) $(CXX) -export-dynamic -fPIC $(CXXFLAGS) -o $@ $<
else
%.o: %.cc
	$(CXX)  -fPIC $(CXXFLAGS) -c $<
%.o: %.cpp
	$(CXX)  -fPIC $(CXXFLAGS) -c $<
%.o: %.c
	$(CC)  -fPIC $(CFLAGS) -c $<

%.so: %.cpp
	$(CXX) -shared -fPIC $(CXXFLAGS) -o $@ $< $(LIBS)
endif

%.py: %.i
	$(SWIG) $(SWIGFLAGS) -o junk $<

%.cpp: %.i
	$(SWIG) $(SWIGFLAGS) -o $(ODIR)/$@ $<

%cmodule.so: %.o
	$(CXX) -shared $< -lswigpy -o $(ODIR)/$@

%.dvi: %.htex
	cp $< tmp.tex ; $(BUILDDIR)/extra/scripts/striphelpids tmp.tex ; $(LATEX) tmp.tex ; $(MAKEINDEX) tmp.idx; \
        $(LATEX) tmp.tex ; $(LATEX) tmp.tex ; mv tmp.dvi `basename $< .htex`.dvi; mv tmp.aux `basename $< .htex`.aux ;rm -f tmp.*

%.dvi: %.tex
	$(LATEX) $< ; $(MAKEINDEX) `basename $< .tex`.idx; $(LATEX) $< ; $(LATEX) $<

%.ps: %.dvi
	$(DVIPS) $< -o $@

%.pdf: %.ps
	$(PSTOPDF) $< $@

ifdef HAVE_SGMLTOOLS
%.html: %.sgml
	sgml2html $<
else
%.html: %.sgml
	touch $(ODIR)/$@ 
endif

# We use the _PYCODE CXXFLAGS here, as we want to ignore all warnings
# when making depend. Otherwise make would fail.
dep depend:
	$(CXX) -MM $(CXXFLAGS_PYCODE) $(SRC) >.depend
#	$(CC) -MM $(CXXFLAGS) $(CSRC) >>.depend

.depend:
	touch .depend ; $(MAKE) dep

tags:
	etags --c++ $(SRC) $(CXXSRC)

.PHONY: stdclean dep depend tags msgcat

msgcat:
	@touch $(BUILDDIR)/messages.po
	@for i in $(SRC) $(CSRC) ; do $(XGETTEXT) -C -k_ -j -o $(BUILDDIR)/messages.po $$i ; done

stdclean:
	$(RM) $(ODIR)/*.o $(ODIR)/*.so $(ODIR)/*.a $(ODIR)/*.lo $(ODIR)/.libs
